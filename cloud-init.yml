# SPDX-License-Identifier: MPL-2.0
#cloud-config
# ──────────────────────────────────────────────────────
# Misskey PWA Push Notification Server
# GCE e2-micro (1GB RAM), Debian 12, us-west1-b
#
# Domain: push-kaguya.f3liz.casa
# ──────────────────────────────────────────────────────
#
# Prerequisites:
#   1. Create .env in GCP Secret Manager:
#        gcloud secrets create push-server-env --data-file=.env
#   2. Grant compute SA access:
#        gcloud secrets add-iam-policy-binding push-server-env \
#          --member="serviceAccount:$(gcloud iam service-accounts list \
#            --filter='email~compute@developer' --format='value(email)')" \
#          --role="roles/secretmanager.secretAccessor"
#   3. Create instance:
#        gcloud compute instances create push-kaguya \
#          --zone=us-west1-b \
#          --machine-type=e2-micro \
#          --image-family=debian-12 \
#          --image-project=debian-cloud \
#          --metadata-from-file=user-data=cloud-init.yml \
#          --scopes=cloud-platform \
#          --tags=http-server,https-server
#
# Progress: tail -f /var/log/cloud-init-output.log

package_update: true
package_upgrade: true

packages:
  - curl
  - git
  - nginx
  - certbot
  - python3-certbot-nginx
  - sqlite3
  - ufw
  - fail2ban
  - unzip
  - build-essential
  - autoconf
  - libncurses5-dev
  - libssl-dev

write_files:
  # --- Nginx site config ---
  - path: /etc/nginx/sites-available/push-server
    content: |
      upstream elixir {
          server 127.0.0.1:4000;
          keepalive 32;
          keepalive_requests 1000;
          keepalive_timeout 60s;
      }

      upstream node_fallback {
          server 127.0.0.1:3000;
          keepalive 8;
      }

      # Rate limit: 10 req/s per IP (burst 20)
      limit_req_zone $binary_remote_addr zone=webhook:10m rate=10r/s;

      server {
          listen 80;
          server_name push-kaguya.f3liz.casa;

          # CORS for kaguya SPA
          set $cors_origin "";
          if ($http_origin ~* "^https://kaguya\.f3liz\.casa$") {
              set $cors_origin $http_origin;
          }

          # Webhook: Elixir primary, Node.js fallback
          location /webhook/ {
              limit_req zone=webhook burst=20 nodelay;

              proxy_pass http://elixir;
              proxy_http_version 1.1;
              proxy_set_header Connection "";
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;

              proxy_connect_timeout 3s;
              proxy_read_timeout    10s;
              proxy_send_timeout    10s;

              proxy_next_upstream error timeout http_500 http_502 http_503 http_504;
              proxy_next_upstream_tries   2;
              proxy_next_upstream_timeout 5s;

              error_page 500 502 503 504 = @node_fallback;
              proxy_intercept_errors on;
          }

          location @node_fallback {
              proxy_pass http://node_fallback;
              proxy_http_version 1.1;
              proxy_set_header Connection "";
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }

          # Registration/settings/health: Elixir only, CORS enabled
          location / {
              # CORS headers
              add_header Access-Control-Allow-Origin $cors_origin always;
              add_header Access-Control-Allow-Methods "GET, POST, PATCH, DELETE, OPTIONS" always;
              add_header Access-Control-Allow-Headers "Content-Type" always;
              add_header Access-Control-Max-Age 86400 always;

              if ($request_method = OPTIONS) {
                  return 204;
              }

              proxy_pass http://elixir;
              proxy_http_version 1.1;
              proxy_set_header Connection "";
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
              proxy_set_header X-Forwarded-Proto $scheme;

              proxy_connect_timeout 3s;
              proxy_read_timeout    10s;
          }

          # Security headers
          add_header X-Content-Type-Options nosniff always;
          add_header X-Frame-Options DENY always;
          add_header Referrer-Policy no-referrer always;

          client_max_body_size 64k;
      }

  # --- systemd: Node.js fallback ---
  - path: /etc/systemd/system/push-server-node.service
    content: |
      [Unit]
      Description=Push Server (Node.js fallback)
      After=network.target

      [Service]
      Type=exec
      User=push
      Group=push
      WorkingDirectory=/app/node

      ExecStart=/usr/bin/node --max-old-space-size=128 server.mjs

      Restart=always
      RestartSec=3s

      MemoryHigh=100M
      MemoryMax=128M
      MemorySwapMax=0

      EnvironmentFile=/app/.env

      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=push-node

      [Install]
      WantedBy=multi-user.target

  # --- systemd: Elixir primary ---
  - path: /etc/systemd/system/push-server-elixir.service
    content: |
      [Unit]
      Description=Push Server (Elixir primary)
      After=network.target push-server-node.service
      Wants=push-server-node.service

      [Service]
      Type=exec
      User=push
      Group=push
      WorkingDirectory=/app/elixir

      ExecStart=/app/elixir/bin/push_server start
      ExecStop=/app/elixir/bin/push_server stop

      Restart=always
      RestartSec=5s

      MemoryHigh=200M
      MemoryMax=256M
      MemorySwapMax=0

      StartLimitIntervalSec=60
      StartLimitBurst=3

      EnvironmentFile=/app/.env

      StandardOutput=journal
      StandardError=journal
      SyslogIdentifier=push-elixir

      [Install]
      WantedBy=multi-user.target

  # --- deploy script ---
  - path: /app/deploy.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      echo "==> pulling latest"
      cd /app/src && git pull

      echo "==> building elixir release"
      cd /app/src/elixir
      sudo -u push bash -c "
        export MIX_ENV=prod
        mix deps.get --only prod
        mix release --overwrite
      "

      echo "==> deploying elixir"
      systemctl stop push-server-elixir || true
      rm -rf /app/elixir/*
      cp -r /app/src/elixir/_build/prod/rel/push_server/* /app/elixir/
      chown -R push:push /app/elixir

      echo "==> deploying node"
      systemctl stop push-server-node || true
      cp /app/src/node/{server.mjs,package.json,tracing.cjs} /app/node/
      cd /app/node && sudo -u push npm install --omit=dev
      chown -R push:push /app/node

      echo "==> restarting"
      systemctl start push-server-node
      sleep 2
      systemctl start push-server-elixir
      sleep 3

      echo "==> health"
      curl -sf http://localhost:4000/health | python3 -m json.tool
      echo "done"

  # --- migration script ---
  - path: /app/migrate.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -euo pipefail
      NEW_SERVER=${1:?"usage: migrate.sh <new-server-ip>"}
      WAIT_MINUTES=${2:-30}

      echo "==> checking new server"
      curl -sf "http://$NEW_SERVER:4000/health" | python3 -m json.tool || {
        echo "ERROR: new server not healthy"; exit 1
      }

      echo "==> waiting ${WAIT_MINUTES}m for pending notifications to drain"
      for i in $(seq $WAIT_MINUTES -1 1); do
        STALE=$(sqlite3 /data/push_server.db \
          "SELECT COUNT(*) FROM pending_notifications" 2>/dev/null || echo "?")
        printf "\r  %2dm remaining — pending: %s  " "$i" "$STALE"
        sleep 60
      done
      echo ""

      PENDING=$(sqlite3 /data/push_server.db \
        "SELECT COUNT(*) FROM pending_notifications" 2>/dev/null || echo "?")
      echo "==> pending rows: $PENDING"

      read -rp "==> stop services? [y/N] " confirm
      if [[ "$confirm" == "y" ]]; then
        systemctl stop push-server-elixir push-server-node
        echo "stopped — safe to delete"
      fi

runcmd:
  # --- swap (512M for e2-micro safety) ---
  - |
    echo "==> creating swap"
    fallocate -l 512M /swapfile
    chmod 600 /swapfile
    mkswap /swapfile
    swapon /swapfile
    echo '/swapfile none swap sw 0 0' >> /etc/fstab

  # --- fetch .env from Secret Manager ---
  - |
    echo "==> fetching .env"
    mkdir -p /app
    if command -v gcloud &>/dev/null; then
      gcloud secrets versions access latest --secret="push-server-env" > /app/.env
    else
      echo "WARN: gcloud not found, using placeholder .env"
      cat > /app/.env <<'ENVEOF'
    DB_PATH=/data/push_server.db
    PORT=4000
    FALLBACK_PORT=3000
    VAPID_PUBLIC_KEY=
    VAPID_PRIVATE_KEY=
    VAPID_SUBJECT=mailto:you@example.com
    ENVEOF
    fi
    chmod 600 /app/.env

  # --- create app user ---
  - |
    echo "==> creating user"
    useradd --system --shell /bin/false --home /app push 2>/dev/null || true
    mkdir -p /app/{elixir,node,src} /data
    chown -R push:push /app /data

  # --- install Erlang/OTP + Elixir via ASDF ---
  - |
    echo "==> installing Erlang + Elixir"
    export DEBIAN_FRONTEND=noninteractive
    # Install Erlang from Erlang Solutions
    curl -fsSL https://binaries2.erlang-solutions.com/debian/erlang-solutions_2.0_all.deb \
      -o /tmp/esl.deb
    dpkg -i /tmp/esl.deb && rm /tmp/esl.deb
    apt-get update -qq
    apt-get install -y -qq erlang elixir

  # --- install Node.js 20 ---
  - |
    echo "==> installing Node.js 20"
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y -qq nodejs

  # --- clone and build ---
  - |
    echo "==> cloning repo"
    git clone https://github.com/f3liz-dev/kaguya-misskey-push-server /app/src
    chown -R push:push /app/src

  - |
    echo "==> building Elixir release"
    cd /app/src/elixir
    sudo -u push bash -c "
      export MIX_ENV=prod
      export HOME=/app
      mix local.hex --force
      mix local.rebar --force
      mix deps.get --only prod
      mix release
    "
    cp -r /app/src/elixir/_build/prod/rel/push_server/* /app/elixir/
    chown -R push:push /app/elixir

  - |
    echo "==> installing Node.js deps"
    cp /app/src/node/{server.mjs,package.json,tracing.cjs} /app/node/
    cd /app/node && sudo -u push npm install --omit=dev
    chown -R push:push /app/node

  # --- firewall ---
  - |
    echo "==> configuring firewall"
    ufw default deny incoming
    ufw default allow outgoing
    ufw allow ssh
    ufw allow 80/tcp
    ufw allow 443/tcp
    ufw --force enable

  # --- nginx ---
  - |
    echo "==> configuring nginx"
    rm -f /etc/nginx/sites-enabled/default
    ln -sf /etc/nginx/sites-available/push-server /etc/nginx/sites-enabled/
    nginx -t && systemctl enable nginx && systemctl restart nginx

  # --- start services ---
  - |
    echo "==> starting services"
    systemctl daemon-reload
    systemctl enable push-server-node push-server-elixir
    systemctl start push-server-node
    sleep 3
    systemctl start push-server-elixir
    sleep 5

  # --- health check ---
  - |
    echo "==> health check"
    curl -sf http://localhost:4000/health | python3 -m json.tool || echo "WARN: health failed"
    echo ""
    echo "==> SETUP COMPLETE"
    echo "    Domain: push-kaguya.f3liz.casa"
    echo "    Elixir: journalctl -u push-server-elixir -f"
    echo "    Node:   journalctl -u push-server-node -f"
    echo "    Nginx:  journalctl -u nginx -f"
    echo ""
    echo "    Next: point DNS to this IP, then:"
    echo "      certbot --nginx -d push-kaguya.f3liz.casa"
    echo "    Or use Cloudflare proxy (no certbot needed)"
