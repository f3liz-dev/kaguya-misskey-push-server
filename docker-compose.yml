# SPDX-License-Identifier: MPL-2.0
# docker-compose.yml — Misskey push notification server
#
# Architecture:
#   nginx (80) → elixir (4000) primary, node (3000) fallback
#   Both share SQLite via host /data mount
#
# GCE free tier: e2-micro (1GB RAM)
# RAM budget:
#   elixir:  256MB max
#   node:    128MB max
#   nginx:    32MB max
#   system:  ~200MB
#   total:   ~616MB of 1GB — comfortable
#
# Production override (docker-compose.override.yml) sets:
#   - /data host mount
#   - /app/.env file
#   - restart: unless-stopped

services:

  # --- Elixir primary server ---
  elixir:
    build:
      context: ./elixir
      dockerfile: Dockerfile
    environment:
      - DB_PATH=/data/push_server.db
      - PORT=4000
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:4000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 30s

  # --- Node.js fallback server ---
  node:
    build:
      context: ./node
      dockerfile: Dockerfile
    environment:
      - DB_PATH=/data/push_server.db
      - FALLBACK_PORT=3000
      - VAPID_PUBLIC_KEY=${VAPID_PUBLIC_KEY}
      - VAPID_PRIVATE_KEY=${VAPID_PRIVATE_KEY}
      - VAPID_SUBJECT=${VAPID_SUBJECT}
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:3000/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

  # --- Nginx reverse proxy ---
  nginx:
    image: nginx:1.27-alpine
    volumes:
      - ./nginx/push-server.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - internal
    deploy:
      resources:
        limits:
          memory: 32M
    depends_on:
      node:
        condition: service_healthy
      elixir:
        condition: service_started  # start nginx even if elixir not healthy yet
                                    # node is the fallback — nginx needs node healthy
networks:
  internal:
    driver: bridge
